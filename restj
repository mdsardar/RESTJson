$(function() {
	$("#tabs").tabs();
});

$("#dialog").dialog({
	autoOpen: false,
    modal: true,
   	width: 400,
   	open: function() {
        $('.ui-widget-overlay').addClass('custom-overlay');
    },
    close: function() {
        $('.ui-widget-overlay').removeClass('custom-overlay');
    }/*,
  	buttons : {
      Ok: function() {
          $(this).dialog("close"); //closing on Ok click
      }
  },*/

});

$("#msgDialog").dialog({
	autoOpen: false,
    modal: true,
   	width: 400,
   	open: function() {
        $('.ui-widget-overlay').addClass('custom-overlay');
    },
    close: function() {
        $('.ui-widget-overlay').removeClass('custom-overlay');
    }
});

$( "#auditDialog").dialog({
	autoOpen: false,
    resizable: false,
    height: 480,
    width: 1100,
    modal: true
  });

$( "#commentsDialog").dialog({
	autoOpen: false,
    resizable: false,
    height: 480,
    width: 830,
    modal: true
  });

$( "#auditDetailDialog").dialog({
	autoOpen: false,
    resizable: false,
    height: 480,
    width: 1100,
    modal: true
  });

$( "#creauditDetailDialog").dialog({
	autoOpen: false,
    resizable: false,
    height: 480,
    width: 1100,
    modal: true
  });

$( "#commentsPopup").dialog({
	autoOpen: false,
    resizable: false,
    height: 150,
    width: 400,
    modal: true,
	open: function() {
        $('.ui-widget-overlay').addClass('custom-overlay');
    },
    close: function() {
        $('.ui-widget-overlay').removeClass('custom-overlay');
    }
});

$( "#msgCommentsPopup").dialog({
	autoOpen: false,
    resizable: false,
    height: 150,
    width: 400,
    modal: true,
	open: function() {
        $('.ui-widget-overlay').addClass('custom-overlay');
    },
    close: function() {
        $('.ui-widget-overlay').removeClass('custom-overlay');
    }
});

$( "#docUploadDialog").dialog({
	autoOpen: false,
    resizable: false,
    height: 280,
    width: 700,
    modal: true
  });

var tabStatusArr = {};
var tabReadOnlyArr = {};
var formNameArr = {};
var formOrderArr = {};
var infoCodeArr = ["SUBCDD0004", "SUBCDD0007", "SUBCDD0008","SUBCDD0009","SUBCDD0010","SUBCDD0011","SUBCDD0014"];

formNameArr.CALL_VISIT_REPORT = "callVisitForm";
formNameArr.SPF = null;
formNameArr.EDD = "eddVO";
formNameArr.SOW = "cddSowVO";
formNameArr.TRADE_ATTEST_FORM = "TradeAttesationForm";
formNameArr.DUE_DELIGENCE = "dueDiligenceAttestationVO";
formNameArr.ATTESTATION = "dueDiligenceAttestationVO";
formNameArr.KYC_REFRESH_ASSESSMENT = "kycRefreshAssessmentForm";
formNameArr.PUP = "productProfileVO";

var saveUrlArr = {};
saveUrlArr.CALL_VISIT_REPORT = "callVisit/submitCallVisit";
saveUrlArr.SPF = "spf/submitOverallRiskDetails";
saveUrlArr.SOW = "sow/save";
saveUrlArr.EDD = "edd/saveEdd";
saveUrlArr.TRADE_ATTEST_FORM = "tradeAttest/submitTradeAttesation";
saveUrlArr.DUE_DELIGENCE = "duediligenceattestation/saveDueDiligence";
saveUrlArr.ATTESTATION = "duediligenceattestation/saveDueDiligence";
saveUrlArr.KYC_REFRESH_ASSESSMENT = "kycRefReview/save";
saveUrlArr.PUP = "pup/savePup";

function getParentDetail(){
	if(document.getElementById('hdnCddControlNumber')) {
		document.getElementById('hdnCddControlNumber').value = parent.document.getElementById('cddControlNumber').value;
	}
	if(document.getElementById('hdnCustType')) {
		document.getElementById('hdnCustType').value = parent.document.getElementById('custType').value;
	}
	if(document.getElementById('hdnCddType')) {
		document.getElementById('hdnCddType').value = parent.document.getElementById('cddType').value;
	}
	if(document.getElementById('hdnRiskRating')) {
		document.getElementById('hdnRiskRating').value = parent.document.getElementById('formRiskRating').value;
	}
	if(document.getElementById('hdnBusinessLine')) {
		document.getElementById('hdnBusinessLine').value = parent.document.getElementById('businessLine').value;
	}
	if(document.getElementById('hdnSpfFlag')) {
		document.getElementById('hdnSpfFlag').value = parent.document.getElementById('spfFlag').value;
	}
	if(document.getElementById('hdnCustomerNumber')) {
		document.getElementById('hdnCustomerNumber').value = parent.document.getElementById('customerNumber').value;
	}
	if(document.getElementById('hdnIsOverlapping')) {
		document.getElementById('hdnIsOverlapping').value = parent.document.getElementById('isOverlapping').value;
	}
	if(document.getElementById('hdnCountry')) {
		document.getElementById('hdnCountry').value = parent.document.getElementById('country').value;
	}
	if(document.getElementById('hdnCustNumber')) {
		document.getElementById('hdnCustNumber').value = parent.document.getElementById('custNumber').value;
	}
	
}

function setCddValues() {
	var obj = JSON.parse(cdd);
	var tabDetail = obj.tabDetailsMap;
	var keys = Object.keys(tabDetail);
	var isScreenReadonly = document.getElementById("isScreenReadOnly").value;
	for (var i = 0; i < keys.length; i++) {
		var key = keys[i];
		var tabName = tabDetail[key].tabName;
		var tabStatus = tabDetail[key].tabStatus;
		var readOnlyFlag = tabDetail[key].isReadOnly;
		tabStatusArr[key] = tabStatus;
		if(tabStatus!='COMPLETED' && document.getElementById(key+"_LI")!=null && isScreenReadonly=="N"){
			document.getElementById(key+"_LI").style.border = "#ff6666 solid 2px"
		}
		tabReadOnlyArr[key] = readOnlyFlag;
		formOrderArr[key] = i;
	}
	/*if(document.getElementById('isScreenReadOnly').value=='N'){
		moveToIncompletedTab();
	}else{
		loadForm('clientProfile/init');
	}*/
	if(obj.isMigrated =='Y'){
		document.getElementById('currScreenName').value = "DOCUMENTS";
		document.getElementById("selectedFormName").value = "DOCUMENTS";
		loadSpfForm('cddUploadDoc/init');
	} else {
		document.getElementById('currScreenName').value = "CLIENT_PROFILE";
		document.getElementById("selectedFormName").value = "CLIENT_PROFILE";
		loadSpfForm('clientProfile/init');
	}
}

function getFormStatus(screenName) {
	return tabStatusArr[screenName];
}

function isFormReadonly(screenName) {
	return tabReadOnlyArr[screenName];
}

function moveToIncompletedTab() {
	var keys = Object.keys(tabStatusArr);
	var currentScreen = document.getElementById('currScreenName').value;
	var currentStartIndexFlag=false;
	var startIndex = formOrderArr[currentScreen];
	if(startIndex==keys.length-2){
		startIndex=0;
	}
	for (var i = startIndex; i < keys.length; i++) {
		var key = keys[i];
		var status = tabStatusArr[key];
		if (status != 'COMPLETED' && document.getElementById(key)!=null) {
			currentStartIndexFlag=true;
			document.getElementById(key).click();
			break;
		}
	}
	if(!currentStartIndexFlag){
		for (var i = 0; i < keys.length; i++) {
			var key = keys[i];
			var status = tabStatusArr[key];
			if (status != 'COMPLETED' && document.getElementById(key)!=null) {
				document.getElementById(key).click();
				break;
			}
		}
	}
}

function cancel(url) {
	// window.history.go(-1);
	parent.document.getElementById("contentdiv").innerHTML = '<object type="text/html" width="100%" scrolling="no" style="height:75%; width:100%;position:absolute;overflow:hidden;" data="'
			+ url + '" ></object>';
}

function loadForm(obj,pageUrl) {
	showPopupLoader();
	formAutoSave(obj);
	formAutoSaveJson(obj);
	var screenName = obj.id;
	document.getElementById("selectedFormName").value = screenName;
	$('#formdiv').empty();
	var jsonData = generateJsonData();
	$.ajax({
		method : "POST",
		contentType : "application/json",
		url : pageUrl,
		data : jsonData,
		success : function(data) {
			closePopupLoader();
			document.getElementById('currScreenName').value = screenName;
			document.getElementById("selectedFormName").value = "";
			$('#formdiv').html(data);
			onChangeFunc();
		},
		error: function (request, status, error) {
			closePopupLoader();
			$('#formdiv').load("error.jsp");
	    }
	});
}

function formAutoSave(obj) {
	var selectedScreenName = obj.id;
	var screenName = $("#currScreenName").val();
	if(selectedScreenName!=screenName){
		if(screenName!='EDD' && screenName!='SPF' && screenName != 'SOW' && screenName != 'KYC_REFRESH_ASSESSMENT' && screenName != 'PUP' ){
			var formStatus = tabStatusArr[screenName];
			var isTabReadonly = tabReadOnlyArr[screenName];
			if($("#isScreenReadOnly").val()=='N' && isTabReadonly == 'N'){
				var formName = formNameArr[screenName];
				var dataParams = null;
				if(formName != null){
					if(screenName=='CALL_VISIT_REPORT' ){						
						isDisableForSave(false);
						preapareSaveCallVisit();
					}
					if(screenName=='TRADE_ATTEST_FORM' ){
						checkSourceFieldsValueBeforeDataParamsPreparation(false);
					}
					if(screenName=='DUE_DELIGENCE' || screenName=='ATTESTATION'){
						prepareDataBeforSave();
					}
					dataParams = appendWithBaseForm(formName);
					
					if(screenName=='CALL_VISIT_REPORT' ){
						isDisableForSave(true);
					}
					if(screenName=='TRADE_ATTEST_FORM' ){
						checkSourceFieldsValueBeforeDataParamsPreparation(true);
					}
				}
				if(dataParams == null || $('#isChanged').val() != 'true') {
					return;
				}
				var furl = saveUrlArr[screenName];
					$.ajax({
					type : "POST",
					url : furl,
					async : true,
					data : dataParams,
					
					success : function(data) {
						updateAutoSaveStatus(data,screenName);
					},
					error : commonError
				});
			}	
		} 
	}
}

function formAutoSaveJson(obj) {
	var selectedScreenName = obj.id;
	var screenName = $("#currScreenName").val();
	if(selectedScreenName!=screenName){
		if(screenName=='EDD' || screenName=='SPF' || screenName == 'SOW' || screenName == 'KYC_REFRESH_ASSESSMENT' || screenName == 'PUP'){
			var formStatus = tabStatusArr[screenName];
			var isTabReadonly = tabReadOnlyArr[screenName];
			if($("#isScreenReadOnly").val()=='N' && isTabReadonly == 'N'){
				var formName = formNameArr[screenName];
				var dataParams = null;
				if(formName != null){
					dataParams = appendWithBaseForm(formName);
				}
				if(screenName=='EDD' ){
					dataParams=getEddJson();
				}
				if(screenName=='PUP' ){
					dataParams=getPUPJson();
					if(document.getElementById("idPupSave")!=null && document.getElementById("idPupSave").style.display==''){
						$('#isChanged').val('true');
					}
				}
				
				if(screenName=='SPF'){
					if(document.getElementById("spfAddendumQuestInnerDivId")){
						saveUrlArr.SPF = "spf/submitAddendumQuestionnaire";
						dataParams=preapreAddendumQuestionnaireData();
					}else if(document.getElementById("spfOverallRiskSummaryDivId")){
						saveUrlArr.SPF = "spf/submitOverallRiskDetails";
						dataParams=prepareOverallRiskSummaryData();
					}else{
						dataParams = null;
					}
				} else if(screenName == 'SOW'){
					dataParams = prepareSowJson();
				}  else if(screenName == 'KYC_REFRESH_ASSESSMENT'){
					dataParams = getKycRefreshReviewJson();
				}
				if(dataParams == null || $('#isChanged').val() != 'true') {
					return;
				}
				var furl = saveUrlArr[screenName];
					$.ajax({
					type : "POST",
					url : furl,
					async : true,
					data : dataParams,
					contentType : "application/json",
					success : function(data) {
						updateJsonAutoSaveStatus(data,screenName);
					},
					error : commonError
				});
					
			}
		}
	}
}

function submitFormAutoSave() {
	var screenName = $("#currScreenName").val();
	if(screenName!='EDD' && screenName!='SPF' && screenName != 'SOW' && screenName != 'KYC_REFRESH_ASSESSMENT' && screenName != 'PUP' 
		&& screenName!='CLIENT_PROFILE' && screenName!='RISK_SUMMARY' && screenName != 'DOCUMENTS'){
		var formStatus = tabStatusArr[screenName];
		var isTabReadonly = tabReadOnlyArr[screenName];
		if($("#isScreenReadOnly").val()=='N' && isTabReadonly == 'N'){
			var formName = formNameArr[screenName];
			var dataParams = null;
			if(formName != null){
				if(screenName=='CALL_VISIT_REPORT' ){
					isDisableForSave(false);
				}
				if(screenName=='TRADE_ATTEST_FORM' ){
					checkSourceFieldsValueBeforeDataParamsPreparation(false);
				}
				if(screenName=='DUE_DELIGENCE'|| screenName=='ATTESTATION' ){
					if(document.getElementById("kycflag").checked == true){
						document.getElementById("ackClientKycProfile").value="Y";
					}else{
						document.getElementById("ackClientKycProfile").value="N";
					}
				}
				
				
				dataParams = appendWithBaseForm(formName);
				if(screenName=='CALL_VISIT_REPORT' ){
					isDisableForSave(true);
				}
				if(screenName=='TRADE_ATTEST_FORM' ){
					checkSourceFieldsValueBeforeDataParamsPreparation(true);
				}
			}
			if(dataParams == null || $('#isChanged').val() != 'true') {
				submitFormAutoSaveJson();
				return;
			}
			var furl = saveUrlArr[screenName];
			showPopupLoader();
				$.ajax({
				type : "POST",
				url : furl,
				async : true,
				data : dataParams,
				success : function(data) {
					closePopupLoader();
					updateSubmitAutoSaveStatus(data,screenName);
					submitFormAutoSaveJson();
				},
				error : commonError
			});
		}else{
			submitFormAutoSaveJson();
		}
	}else{
		submitFormAutoSaveJson();
	}
}

function submitFormAutoSaveJson() {
	var screenName = $("#currScreenName").val();
	if(screenName=='EDD' || screenName=='SPF' || screenName == 'SOW' || screenName == 'KYC_REFRESH_ASSESSMENT' || screenName == 'PUP'){
		var formStatus = tabStatusArr[screenName];
		var isTabReadonly = tabReadOnlyArr[screenName];
		if($("#isScreenReadOnly").val()=='N' && isTabReadonly == 'N'){
			var formName = formNameArr[screenName];
			var dataParams = null;
			if(formName != null){
				dataParams = appendWithBaseForm(formName);
			}
			if(screenName=='EDD' ){
				dataParams=getEddJson();
			}
			if(screenName=='PUP' ){
				dataParams=getPUPJson();
				if(document.getElementById("idPupSave")!=null && document.getElementById("idPupSave").style.display==''){
					$('#isChanged').val('true');
				}
			}
			
			if(screenName=='SPF'){
				if(document.getElementById("spfAddendumQuestInnerDivId")){
					saveUrlArr.SPF = "spf/submitAddendumQuestionnaire";
					dataParams=preapreAddendumQuestionnaireData();
				}else if(document.getElementById("spfOverallRiskSummaryDivId")){
					saveUrlArr.SPF = "spf/submitOverallRiskDetails";
					dataParams=prepareOverallRiskSummaryData();
				}else{
					dataParams = null;
				}
			} else if(screenName == 'SOW'){
				dataParams = prepareSowJson();
			}  else if(screenName == 'KYC_REFRESH_ASSESSMENT'){
				dataParams = getKycRefreshReviewJson();
			}
			if(dataParams == null || $('#isChanged').val() != 'true'){
				validateSubmit();
				return;
			}
			var furl = saveUrlArr[screenName];
			showPopupLoader();
				$.ajax({
				type : "POST",
				url : furl,
				async : true,
				data : dataParams,
				contentType : "application/json",
				success : function(data) {
					closePopupLoader();
					updateJsonSubmitAutoSaveStatus(data,screenName);
					validateSubmit();
				},
				error : commonError
			});
				
		}else{
			validateSubmit();
		}
	}else{
		validateSubmit();
	} 
}

function openUploadDocumentPopup(isFrom,questionId,tabName,componentId,attachmentId) {
	var furl="cddUploadDoc/initCddUploadDocPopup?countryCode="+parent.document.getElementById('country').value
			+"&controlNumber="+parent.document.getElementById('cddControlNumber').value
			+"&custNumber="+parent.document.getElementById('customerNumber').value
			+"&businessLine="+parent.document.getElementById('businessLine').value
			+"&custType="+parent.document.getElementById('clientType').value
			+"&riskRating="+parent.document.getElementById('formRiskRating').value
			+"&formVersion="+parent.document.getElementById('formVersion').value
			+"&cddType="+parent.document.getElementById('cddType').value
			+"&isFrom="+isFrom+"&QuestionId="+questionId+"&TabName="+tabName+"&componentId="+componentId+"&attachmentId="+attachmentId;
	$("#docUploadDialog").load(furl);
    $("#docUploadDialog").dialog("open");
}

function generateJsonData() {
	var formReadonly = "Y";
	if(document.getElementById("selectedFormName")!=null && 
			!checkNull(document.getElementById("selectedFormName").value)){
		formReadonly = isFormReadonly(document.getElementById("selectedFormName").value);
	}
	var jsonData = '{"cddControlNumber":"'
			+ document.getElementById("cddControlNumber").value + '","country":"'
			+ document.getElementById("country").value + '","custNumber":"'
			+ document.getElementById("customerNumber").value + '","businessLine":"'
			+ document.getElementById("businessLine").value + '","custType":"'
			+ document.getElementById("clientType").value + '","formRiskRating":"'
			+ document.getElementById("formRiskRating").value + '","formVersion":"'
			+ document.getElementById("formVersion").value + '","clientType":"'
			+ document.getElementById("clientType").value + '","cddType":"'
			+ document.getElementById("cddType").value +'","cddTriggerDate":"'
			+ document.getElementById("cddTriggerDate").value +'","overlapping":"'
			+ document.getElementById("isOverlapping").value +'","riskRatingDesc":"'
			+ document.getElementById("riskRatingDesc").value +'","triggerType":"'
			+ document.getElementById("hdnTriggerType").value +'","custClientType":"'
			+ document.getElementById("custClientType").value +'","isFormReadonly":"'
			+ formReadonly +'"}';
	return jsonData;
	
}

function updateFormStatus(screenName, screenStatus){
	var isScreenReadonly = document.getElementById("isScreenReadOnly").value;
	if(tabStatusArr[screenName]!=null && isScreenReadonly=="N"){
		tabStatusArr[screenName] = screenStatus;
		var jsonData = '{"cddControlNumber":"'
			+ document.getElementById("cddControlNumber").value + '","country":"'
			+ document.getElementById("country").value + '","screenName":"'
			+ screenName + '","screenStatus":"'
			+ screenStatus + '"}';
	
		$.ajax({
			method : "POST",
			contentType : "application/json",
			url : "cdd/updateFormStatus",
			data : jsonData,
			success : function(data) {
				var onChangeObj = $('#isChanged');
				onChangeObj.val('false');
				if(screenStatus=='COMPLETED'){
					document.getElementById(screenName+"_LI").style.border = "1px solid #c5c5c5";
					moveToIncompletedTab();
				}else{
					document.getElementById(screenName+"_LI").style.border = "#ff6666 solid 2px"
				}
			}
		});
	}
}


function updateReadonlyFormStatus(screenName, screenStatus,isFromHitDetailsSave){
	var isScreenReadonly = document.getElementById("isScreenReadOnly").value;
	if(tabStatusArr[screenName]!=null && isScreenReadonly=="N"){
		tabStatusArr[screenName] = screenStatus;
		var jsonData = '{"cddControlNumber":"'
			+ document.getElementById("cddControlNumber").value + '","country":"'
			+ document.getElementById("country").value + '","screenName":"'
			+ screenName + '","screenStatus":"'
			+ screenStatus + '"}';
		$.ajax({
			method : "POST",
			contentType : "application/json",
			url : "cdd/updateFormStatus",
			data : jsonData,
			success : function(data) {
				if(screenStatus=='COMPLETED'){
					document.getElementById(screenName+"_LI").style.border = "1px solid #c5c5c5";
					if(screenName == 'MEMBER_SCREENING' && isFromHitDetailsSave !=  null 
							&& isFromHitDetailsSave != undefined && isFromHitDetailsSave != ''
							&& isFromHitDetailsSave != 'null' && isFromHitDetailsSave != 'undefined'
							&& isFromHitDetailsSave == 'Y' ){
						isFromHitDetailsSave = 'N';
						moveToIncompletedTab();
					}
				}else{
					document.getElementById(screenName+"_LI").style.border = "#ff6666 solid 2px"
				}
			}
		});
	}
}

function appendWithBaseForm(formName){
	var dataString = $('form[name=baseForm]').serialize()+"&"+$('form[name='+formName+']').serialize();
	return dataString;
}

function openAuditLog(){
	var contry = document.getElementById('country').value;
    var controlNbr = document.getElementById('cddControlNumber').value;
    var customerNbr = document.getElementById('custNumber').value;
    var auditFlagValue = document.getElementById('auditFlag').value;
    
    if (controlNbr === null || controlNbr.trim() === "" || controlNbr === ' ') {
           controlNbr = 'NA';
                 }
    if (customerNbr == null || customerNbr.trim() == "" || customerNbr === ' ') {
           customerNbr = 'NA';
    }
    
    var furl1="auditlogview/init/"+contry+"/"+controlNbr+"/"+customerNbr+"/"+auditFlagValue;
	
	//var furl="auditlogview/init/"+document.getElementById('country').value
	//+"/"+document.getElementById('cddControlNumber').value;
	/*window.open(furl,'Audit Log','width='+screen.width+',height=300');*/
	$("#auditDialog").load(furl1);
    $("#auditDialog").dialog("open");
}

function openKycComments(){
	var contry = document.getElementById('country').value;
    var controlNbr = document.getElementById('cddControlNumber').value;
    var customerNbr = document.getElementById('custNumber').value;
    
    if (controlNbr === null || controlNbr.trim() == "" || controlNbr === ' ') {
           controlNbr = 'NA';
                 }
    if (customerNbr == null || customerNbr.trim() == "" || customerNbr === ' ') {
           customerNbr = 'NA';
                 }
    var furl="kyccomments/init/"+contry+"/"+controlNbr+"/"+customerNbr;

	
	
	/*var furl="kyccomments/init/"+document.getElementById('country').value
	+"/"+document.getElementById('cddControlNumber').value;*/
	/*window.open(furl,'Kyc Comments','width='+screen.width+',height=300');*/
	$("#commentsDialog").load(furl);
    $("#commentsDialog").dialog("open");
}

function initiateUserAction(){
	var actionType = document.getElementById("actionType").value;
	document.getElementById("actionType").value="";
	document.getElementById('baseOkBtn').innerHTML = $("#hdnOkBtn").text();
	if(actionType.toUpperCase()=="SUBMIT"){
		submitCdd();
	}else if(actionType.toUpperCase()=="REFRESH"){
		refreshCdd();
	}else if(actionType.toUpperCase()=="APPROVE"){
		approveCdd();
	}else{
		updateCddResponse(actionType);
	}
}

function validateSubmit(){
	document.getElementById('baseOkBtn').innerHTML = $("#hdnOkBtn").text();
	$.ajax({
		type : "POST",
		url : "cdd/validateSubmit",
		data : $('form[name=baseForm]').serialize(),
		success : afterValidateSubmit,
		error : commonError
	});
}

function afterValidateSubmit(respTxt,status) {
	closePopupLoader();
	if (respTxt != '') {
		var resultJson = JSON.parse(respTxt);
		var infoMessage = resultJson.infoMessage;
		var infoMessageCode = resultJson.infoMessageCode;
		var formArr = resultJson.incompletedTabs;
		if(infoMessageCode!=null && infoMessageCode!=''){
			  if(formArr!=null){
				  for (var i = 0; i < formArr.length; i++) {
					  if(document.getElementById(formArr[i]+"_LI")){
						  document.getElementById(formArr[i]+"_LI").style.border = "#ff6666 solid 2px";
					  }
				  }
			  }
			  document.getElementById("msgCode").value=infoMessageCode;
			  $( "#cddInfoMsg" ).text(infoMessage);
			  document.getElementById('baseOkBtn').innerHTML = $("#hdnOkBtn").text();
			  $( "#msgDialog" ).dialog("open");
		}else{
			showActionCommentPopup(document.getElementById("submitBtn"),'SUBMIT');
		}
	}
}

function submitCdd(){
	$.ajax({
		type : "POST",
		url : "cdd/submit",
		data : $('form[name=baseForm]').serialize(),
		success : afterSubmit,
		error : commonError
	});
}

function afterSubmit(respTxt,status) {
	closePopupLoader();
	if (respTxt != '') {
		var resultJson = JSON.parse(respTxt);
		var infoMessage = resultJson.infoMessage;
		var infoMessageCode = resultJson.infoMessageCode;
		var consumeRefreshFlag = resultJson.consumeRefreshFlag;
		var formArr = resultJson.incompletedTabs;
		  if(infoMessage!=null && infoMessage!=''){
			  if(infoMessageCode!=null && infoMessageCode!='' && infoMessageCode == "SUBCDD0002"){
					  var url = "cdd/init/"+document.getElementById("cddControlNumber").value;
					  openPage(url);
			  }
			  /*if(parent.document.getElementById("refreshBtn")!=null){
				  if(consumeRefreshFlag!=null && consumeRefreshFlag==true){
					  parent.document.getElementById("refreshBtn").disabled=false;
				  }else{
					  parent.document.getElementById("refreshBtn").disabled=true;
				  }
			  }*/
			  if(formArr!=null){
				  for (var i = 0; i < formArr.length; i++) {
					  if(document.getElementById(formArr[i]+"_LI")){
						  document.getElementById(formArr[i]+"_LI").style.border = "#ff6666 solid 2px";
					  }
				  }
			  }
			  document.getElementById("msgCode").value=infoMessageCode;
			  $( "#cddInfoMsg" ).text(infoMessage);
			  document.getElementById('baseOkBtn').innerHTML = $("#hdnOkBtn").text();
			  $( "#msgDialog" ).dialog("open");
		  }
	}
}

function refreshCdd(){
	document.getElementById('baseOkBtn').innerHTML = $("#hdnOkBtn").text();
	showPopupLoader();
	$.ajax({
		type : "POST",
		url : "cdd/refresh",
		data : $('form[name=baseForm]').serialize(),
		success : afterRefresh,
		error: commonError
	});
}

function afterRefresh(respTxt,status) {
	closePopupLoader();
	if (respTxt != '') {
		var resultJson = JSON.parse(respTxt);
		var infoMessage = resultJson.infoMessage;
		var infoMessageCode = resultJson.infoMessageCode;
		var consumeRefreshFlag = resultJson.consumeRefreshFlag;
		  if(infoMessage!=null && infoMessage!=''){
			  if(infoMessageCode!=null && infoMessageCode!='' && (infoMessageCode == "SUBCDD0002" || infoMessageCode == "SUBCDD0012" 
				  || infoMessageCode == "SUBCDD0013" || infoMessageCode == "REFCDD0002")){
				  var url = "cdd/init/"+document.getElementById("cddControlNumber").value;
				  openPage(url);
			  }
			  /*if(parent.document.getElementById("refreshBtn")!=null){
				  if(consumeRefreshFlag!=null && consumeRefreshFlag==true){
					  parent.document.getElementById("refreshBtn").disabled=false;
				  }else{
					  parent.document.getElementById("refreshBtn").disabled=true;
				  }
			  }*/
			  $( "#cddInfoMsg" ).text(infoMessage);
			  document.getElementById('baseOkBtn').innerHTML = $("#hdnOkBtn").text();
			  $( "#msgDialog" ).dialog("open");
		  }
	}
}

function approveCdd(){
	$.ajax({
		type : "POST",
		url : "cdd/approve",
		data : $('form[name=baseForm]').serialize(),
		success : afterApprove,
		error : commonError
	});
}

function afterApprove(respTxt, status) {
	closePopupLoader();
	if (respTxt != '') {
		var resultJson = JSON.parse(respTxt);
		var infoMessage = resultJson.infoMessage;
		var infoMessageCode = resultJson.infoMessageCode;
		  if(infoMessage!=null && infoMessage!=''){
			  document.getElementById("msgCode").value=infoMessageCode;
			  $( "#cddInfoMsg" ).text(infoMessage);
			  document.getElementById('baseOkBtn').innerHTML = $("#hdnOkBtn").text();
			  $( "#msgDialog" ).dialog("open");
		  }
	}
}
//Pre-prod 656
function updateCddResponse(action){
	$.ajax({
		type : "POST",
		url : "cdd/updateCdd/"+action,
		data : $('form[name=baseForm]').serialize(),
		success : afterUpdateResponse,
		error : commonError
	});
}

function afterUpdateResponse(respTxt, status) {
	closePopupLoader();
	if (respTxt != '') {
		var resultJson = JSON.parse(respTxt);
		var infoMessage = resultJson.infoMessage;
		var infoMessageCode = resultJson.infoMessageCode;
		document.getElementById("msgCode").value=infoMessageCode;
		if(infoMessage!=null && infoMessage!=''){
		  $( "#cddInfoMsg" ).text(infoMessage);
		  document.getElementById('baseOkBtn').innerHTML = $("#hdnOkBtn").text();
		  $( "#msgDialog" ).dialog("open");
		}
	}
}

function loadWipPage() {
	showPopupLoader();
	$('#formdiv').empty();
	$.ajax({
		method : "GET",
		url : "wip",
		data : "",
		success : function(data) {
			closePopupLoader();
			$('#formdiv').html(data);
		},
		error: function (request, status, error) {
			closePopupLoader();
	    }
	});
}

function showActionCommentPopup(obj,actionType){
	if(obj!=null){
		if(actionType=='RETURN_MAKER' || actionType=='OBJECTION' 
			|| actionType=='NO_OBJECTION' || actionType=='TERMINATED'){
			document.getElementById('mandCommentsId').style.display="";
		}else{
			document.getElementById('mandCommentsId').style.display='none';
		}
		var btnId = obj.id;
		var btnValue = $("#"+btnId).text().trim();
		document.getElementById('submitCmtBtn').innerHTML = btnValue;
		document.getElementById('baseCancelCmtBtn').innerHTML = $("#hdnCancelBtn").text();
		document.getElementById("actionType").value = actionType;
	}
	$("#msgCommentsPopup").dialog("open");
}

function validateComments(){
	var actionType = document.getElementById("actionType").value;
	if(actionType=='RETURN_MAKER' || actionType=='RETURN_CHECKER' || 
			actionType=='OBJECTION' || actionType=='NO_OBJECTION' || actionType=='TERMINATED'){
		var actionCmnts = $("#actionCmnts").val();
		if(checkNull(actionCmnts)){
			$("#msgCommentsPopup").dialog("close");
			$( "#cddInfoMsg" ).text("Please enter Comments.");
			document.getElementById('baseOkBtn').innerHTML = $("#hdnOkBtn").text();
			$( "#msgDialog" ).dialog("open");
			return false;
		}
	}
	return true;
}

function saveActionComments(){
	if(validateComments()){
		var btnValue = $("#submitCmtBtn").text().trim();
		var actionCmnts = $("#actionCmnts").val();
		closeActionComments('msgCommentsPopup');
		showPopupLoader();
		document.getElementById("actionComments").value=actionCmnts;
		setTimeout("initiateUserAction()",100);
	}
}

/** Used by Client Profile search **/
function submitActionComments(){
	if(validateComments()){
		var btnValue = $("#submitCmtBtn").text().trim();
		var actionCmnts = $("#actionCmnts").val();
		closeActionComments('commentsPopup');
		showPopupLoader();
		document.getElementById("actionComments").value=actionCmnts;
		setTimeout("initiateUserAction()",100);
	}
}

function closeActionComments(divId){
	var msgCode = document.getElementById("msgCode").value;
	document.getElementById("actionComments").value="";
	//document.getElementById("actionType").value="";
	document.getElementById("msgCode").value="";
	document.getElementById("actionCmnts").value="";
	$("#"+divId).dialog('close');
}

function closeInfoPopup(divId){
	var msgCode = document.getElementById("msgCode").value;
	document.getElementById("actionComments").value="";
	document.getElementById("actionType").value="";
	document.getElementById("msgCode").value="";
	document.getElementById("actionCmnts").value="";
	$("#"+divId).dialog('close');
	if(msgCode!=''){
		for (var i = 0; i < infoCodeArr.length; i++) {
	        if (infoCodeArr[i] == msgCode) {
	        	openPage('inbox/init');
	        }
		}
	}
}

function closePopup(divId){
	$("#"+divId).dialog('close');
}
function clearDataTable(dataTableId) {
	$('#'+dataTableId).empty();
}

function loadSpfForm(pageUrl) {
	//formAutoSave();
	//var screenName = obj.id;
	showPopupLoader();
	$('#formdiv').empty();
	var jsonData = generateJsonData();
	$.ajax({
		method : "POST",
		contentType : "application/json",
		url : pageUrl,
		data : jsonData,
		success : function(data) {
			closePopupLoader();
			//document.getElementById('currScreenName').value = screenName;
			$('#formdiv').html(data);
			onChangeFunc();
		},
		error: function (request, status, error) {
			closePopupLoader();
			$('#formdiv').load("error.jsp");
	    }
	});
}

function isBlank(str) {
	if (typeof str == 'undefined' || !str || str.length === 0 || str === "" || !/[^\s]/.test(str) || /^\s*$/.test(str) || str.replace(/\s/g,"") === ""){
        return true;
    }else{
        return false;
    }
}

function highlightMandatoryField(item, isMandatory){
	if(isMandatory != null && isMandatory == 'Y'){
		var type = item.type;
		var itemId = item.id;
		if(type == 'select-multiple'){
			 var length = $("#"+itemId+" option").length;
				 if(length == 0){
						$('#'+itemId).addClass('mandatoryFld');
				 }else{
					$('#'+itemId).removeClass('mandatoryFld');
					$('#'+itemId).css("border", "");
				 }
			 return;
		}
		if(isBlank(item.value)){
			$('#'+itemId).addClass('mandatoryFld');
		}else{
			$('#'+itemId).removeClass('mandatoryFld');
			$('#'+itemId).css("border", "");
		}
	}
}

function print(){
	var printForm = document.getElementById('baseForm');
	printForm.method="GET";
	printForm.action="cdd/print";
	printForm.submit();
}

function updateFormHighlighting(completionStatus,currentFormName){
	if(!isBlank(completionStatus)){
		document.getElementById("formCompletionStatus").value=completionStatus;
		var formStatusListArr = completionStatus.split("~");
		tabStatusArr={};
		formOrderArr = {}
		for (var i = 0; i < formStatusListArr.length; i++) {
		    var formStatus = formStatusListArr[i];
		    if(!isBlank(formStatus)){
		    	var formStatusArr = formStatus.split("=");
		    	var formName = formStatusArr[0];
		    	var formStatus = formStatusArr[1];
		    	tabStatusArr[formName] = formStatus;
		    	formOrderArr[formName] = i;
		    }
		}
		var onChangeObj = $('#isChanged');
		onChangeObj.val('false');
		var screenStatus = tabStatusArr[currentFormName];
		if(screenStatus=='COMPLETED'){
			document.getElementById(currentFormName+"_LI").style.border = "1px solid #c5c5c5";
			moveToIncompletedTab();
		}else{
			document.getElementById(currentFormName+"_LI").style.border = "#ff6666 solid 2px"
		}
	}
}

function updateFormAutoSaveHighlighting(completionStatus,currentFormName){
	if(!isBlank(completionStatus)){
		document.getElementById("formCompletionStatus").value=completionStatus;
		var formStatusListArr = completionStatus.split("~");
		tabStatusArr={};
		formOrderArr = {}
		for (var i = 0; i < formStatusListArr.length; i++) {
		    var formStatus = formStatusListArr[i];
		    if(!isBlank(formStatus)){
		    	var formStatusArr = formStatus.split("=");
		    	var formName = formStatusArr[0];
		    	var formStatus = formStatusArr[1];
		    	tabStatusArr[formName] = formStatus;
		    	formOrderArr[formName] = i;
		    }
		}
		var onChangeObj = $('#isChanged');
		onChangeObj.val('false');
		var screenStatus = tabStatusArr[currentFormName];
		if(screenStatus=='COMPLETED'){
			document.getElementById(currentFormName+"_LI").style.border = "1px solid #c5c5c5";
		}else{
			document.getElementById(currentFormName+"_LI").style.border = "#ff6666 solid 2px"
		}
	}
}

function updateAutoSaveStatus(data,screenName){
		var completionStatus =""
		if(screenName=='CALL_VISIT_REPORT'){
			var callVisitReportVO = JSON.parse(data);
			completionStatus = callVisitReportVO["formCompletionStatus"];
		} else if(screenName=='ATTESTATION' || screenName=='DUE_DELIGENCE'){
			var jsonData=JSON.parse(data);
			completionStatus = jsonData.formCompletionStatus;
		} else if(screenName == 'TRADE_ATTEST_FORM'){
			var tradeAttestationVO = JSON.parse(data);
			completionStatus = tradeAttestationVO["formCompletionStatus"];
		}
		if(completionStatus !=""){
			document.getElementById(screenName+"_LI").style.border = "1px solid #c5c5c5";
			var onChangeObj = $('#isChanged');
			onChangeObj.val('false');
			updateFormAutoSaveHighlighting(completionStatus,screenName);
		}
}

function updateJsonSubmitAutoSaveStatus(data,screenName){
	var completionStatus =""
	if(screenName=='EDD'){
		var eddVO = JSON.parse(data);
		completionStatus = eddVO["formCompletionStatus"];
	} else if(screenName=='SOW'){
		var sowVo = JSON.parse(data);
		completionStatus = sowVo["formCompletionStatus"];
	} else if(screenName == 'KYC_REFRESH_ASSESSMENT'){
		var kycRefVO = JSON.parse(data);
		completionStatus = kycRefVO["formCompletionStatus"];
	} else if(screenName=='PUP' ){
		var pupVO = JSON.parse(data);
		completionStatus = pupVO["formCompletionStatus"];
	}else if(screenName == 'SPF'){
        var spfVO = JSON.parse(data);
        completionStatus = spfVO["formCompletionStatus"];
	}

	if(completionStatus !=""){
		document.getElementById(screenName+"_LI").style.border = "1px solid #c5c5c5";
		var onChangeObj = $('#isChanged');
		onChangeObj.val('false');
		updateFormHighlighting(completionStatus,screenName);
	}
}

function updateSubmitAutoSaveStatus(data,screenName){
	var completionStatus =""
	if(screenName=='CALL_VISIT_REPORT'){
		var callVisitReportVO = JSON.parse(data);
		completionStatus = callVisitReportVO["formCompletionStatus"];
	} else if(screenName=='ATTESTATION' || screenName=='DUE_DELIGENCE'){
		var jsonData=JSON.parse(data);
		completionStatus = jsonData.formCompletionStatus;
	} else if(screenName == 'TRADE_ATTEST_FORM'){
		var tradeAttestationVO = JSON.parse(data);
		completionStatus = tradeAttestationVO["formCompletionStatus"];
	}
	if(completionStatus !=""){
		document.getElementById(screenName+"_LI").style.border = "1px solid #c5c5c5";
		var onChangeObj = $('#isChanged');
		onChangeObj.val('false');
		updateFormHighlighting(completionStatus,screenName);
	}
}

function updateJsonAutoSaveStatus(data,screenName){
	var completionStatus =""
	if(screenName=='EDD'){
		var eddVO = JSON.parse(data);
		completionStatus = eddVO["formCompletionStatus"];
	} else if(screenName=='SOW'){
		var sowVo = JSON.parse(data);
		completionStatus = sowVo["formCompletionStatus"];
	} else if(screenName == 'KYC_REFRESH_ASSESSMENT'){
		var kycRefVO = JSON.parse(data);
		completionStatus = kycRefVO["formCompletionStatus"];
	} else if(screenName=='PUP' ){
		var pupVO = JSON.parse(data);
		completionStatus = pupVO["formCompletionStatus"];
	}else if(screenName == 'SPF'){
        var spfVO = JSON.parse(data);
        completionStatus = spfVO["formCompletionStatus"];
	}
	if(completionStatus !=""){
		document.getElementById(screenName+"_LI").style.border = "1px solid #c5c5c5";
		var onChangeObj = $('#isChanged');
		onChangeObj.val('false');
		updateFormAutoSaveHighlighting(completionStatus,screenName);
	}
}
